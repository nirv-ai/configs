global
    # haproxy
    # chroot  /var/empty
    daemon
    pidfile /var/run/haproxy.pid
    # security
    maxconn 1000
    fd-hard-limit 50000
    # modules
    lua-load /etc/haproxy/modules/cors.lua
    # ssl
    ssl-default-bind-options ssl-min-ver TLSv1.2
    ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256
    # logging
    log stdout format raw local0 info
    quiet
    # enable runtime api for stats
    stats socket /var/run/api.sock user haproxy group haproxy mode 660 level admin expose-fd listeners
    # user
    group haproxy
    user haproxy


defaults
    backlog 10000
    default-server init-addr last,libc,none
    log global
    mode tcp
    retries 0

    option contstats
    option dontlognull
    option forwardfor
    option http-server-close
    option httplog
    option redispatch

    timeout client          5s
    timeout connect          5s
    timeout http-keep-alive  1s
    timeout http-request    5s
    timeout queue           30s
    timeout server          5s
    timeout tarpit          60s
    timeout tunnel        3600s


# edge accessible http/s on 8080
frontend edge
    bind :8080
    log 127.0.0.1 local0
    maxconn 10000
    option tcplog

    tcp-request content accept if { req.ssl_hello_type 1 }
    tcp-request content accept if HTTP
    tcp-request inspect-delay 100ms

    use_backend forward_http if HTTP
    default_backend forward_https

# forwards edge-http to load-balancer http
backend forward_http
    server serverhttp dev.nirv.ai:8081
# forwards edge-https to load-balancer https
backend forward_https
    server serverhttps dev.nirv.ai:8443

defaults
    backlog 10000
    default-server init-addr last,libc,none
    log global
    mode http
    retries 0

    option contstats
    option dontlognull
    option forwardfor
    option http-server-close
    option httplog
    option redispatch

    timeout client          5s
    timeout connect          5s
    timeout http-keep-alive  1s
    timeout http-request    5s
    timeout queue           30s
    timeout server          5s
    timeout tarpit          60s
    timeout tunnel        3600s

frontend stats
    bind *:8404 ssl crt /etc/ssl/certs/live/dev.nirv.ai/combined.pem
    stats enable
    stats refresh 10s
    stats uri /
    maxconn 100
    stats auth  nirvai:nirvai
    stats admin if TRUE

## edge router for 80|443
frontend edge-load-balancer
    bind :8081 name edgehttp
    bind :8443 name edgehttps ssl crt /etc/ssl/certs/live/dev.nirv.ai/combined.pem
    http-request redirect scheme https code 301 unless { ssl_fc }
    http-request lua.cors "GET,PUT,POST,PATCH" "dev.nirv.ai" "*"
    http-response lua.cors

    maxconn 10000

    capture	request	header	Host    len	20
    capture	request	header	User-Agent  len	16
    capture	request	header	Content-Length  len	10
    capture	request	header	Referer	len	20
    capture	response header	Content-Length	len	10

    acl bff_path path_beg -i /bff/

    use_backend bff if bff_path
    default_backend ui

backend bff
    # removes /bff
    http-request replace-path /bff(/)?(.*) /\2
    server bff1 core_bff:3001


backend ui
    server ui1 core_ui:3000


frontend edge-vault
    mode http
    bind :8200 name vaulthttps ssl crt /etc/ssl/certs/live/dev.nirv.ai/combined.pem

    http-request redirect scheme https code 301 unless { ssl_fc }
    use_backend vault

backend vault
    mode http
    ## dont terminate SSL to vault
    server vault1 core_vault:8300 ssl verify none
