frontend rp-web
    bind :${PROXY_EDGE_RP_HTTP_PORT} name rp-web-h
    bind :${PROXY_EDGE_RP_HTTPS_PORT} name rp-web-s ssl crt "/etc/ssl/certs/live/${PROJECT_HOST_NAME}/combined.pem"

    http-request deny if { path -m sub /. }
    http-request deny if { req.hdr(user-agent) -m len le 32 }
    http-request deny if HTTP_1.0

    http-request lua.cors "GET,PUT,POST,PATCH" "${PROJECT_HOST_NAME}:${PROXY_EDGE_PORT}" "*"
    http-request redirect scheme https code 301 unless { ssl_fc }

    acl bff_path path -i -m beg /bff/
    acl hdr_connection_upgrade req.hdr(Connection)  -i upgrade
    acl hdr_upgrade_websocket  req.hdr(Upgrade)     -i websocket
    acl host_ws req.hdr(Host) -i -m beg ws.
    capture	request	header	Content-Length  len	10
    capture	request	header	Host    len	20
    capture	request	header	Referer	len	20
    capture	request	header	User-Agent  len	16
    capture	response header	Content-Length	len	10
    http-response lua.cors
    maxconn 10000

    default_backend ui
    use_backend bff if bff_path
    use_backend ui if hdr_connection_upgrade
    use_backend ui if hdr_upgrade_websocket
    use_backend ui if host_ws

backend bff
    http-request replace-path /bff(/)?(.*) /\2
    server bff1 "core_bff:${PROXY_BFF_PORT}"

backend ui
    server ui1 "core_ui:${PROXY_UI_PORT}"
